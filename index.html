import React, { useState, useEffect, useRef } from 'react';
import { TrendingUp, TrendingDown, Activity, DollarSign, AlertCircle, Play, Square, Settings } from 'lucide-react';

const DerivDemoBot = () => {
  const [connected, setConnected] = useState(false);
  const [running, setRunning] = useState(false);
  const [balance, setBalance] = useState(10000);
  const [trades, setTrades] = useState([]);
  const [stats, setStats] = useState({ wins: 0, losses: 0, profit: 0 });
  const [apiToken, setApiToken] = useState('');
  const [showSettings, setShowSettings] = useState(true);
  const [logs, setLogs] = useState([]);
  const [strategy, setStrategy] = useState({
    type: 'rsi_ma', // RSI + Moving Average crossover
    stake: 10,
    rsiPeriod: 14,
    rsiOversold: 30,
    rsiOverbought: 70,
    maPeriod: 20,
    stopLoss: 50, // Max loss before stopping
    targetProfit: 100 // Target profit before stopping
  });

  const ws = useRef(null);
  const priceHistory = useRef([]);
  const isRunning = useRef(false);

  const addLog = (message, type = 'info') => {
    setLogs(prev => [...prev.slice(-50), { 
      time: new Date().toLocaleTimeString(), 
      message, 
      type 
    }]);
  };

  // Calculate RSI
  const calculateRSI = (prices, period = 14) => {
    if (prices.length < period + 1) return 50;
    
    let gains = 0, losses = 0;
    for (let i = prices.length - period; i < prices.length; i++) {
      const diff = prices[i] - prices[i - 1];
      if (diff > 0) gains += diff;
      else losses += Math.abs(diff);
    }
    
    const avgGain = gains / period;
    const avgLoss = losses / period;
    if (avgLoss === 0) return 100;
    
    const rs = avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
  };

  // Calculate Simple Moving Average
  const calculateSMA = (prices, period = 20) => {
    if (prices.length < period) return prices[prices.length - 1];
    const slice = prices.slice(-period);
    return slice.reduce((a, b) => a + b, 0) / period;
  };

  // Strategy: RSI + MA Crossover
  const analyzeMarket = () => {
    const prices = priceHistory.current;
    if (prices.length < Math.max(strategy.rsiPeriod + 1, strategy.maPeriod)) {
      return null;
    }

    const rsi = calculateRSI(prices, strategy.rsiPeriod);
    const sma = calculateSMA(prices, strategy.maPeriod);
    const currentPrice = prices[prices.length - 1];

    addLog(`RSI: ${rsi.toFixed(2)}, Price: ${currentPrice.toFixed(5)}, SMA: ${sma.toFixed(5)}`, 'info');

    // Buy signal: RSI oversold AND price below MA (bounce expected)
    if (rsi < strategy.rsiOversold && currentPrice < sma) {
      return { action: 'CALL', confidence: Math.abs(strategy.rsiOversold - rsi) / 10 };
    }
    
    // Sell signal: RSI overbought AND price above MA (drop expected)
    if (rsi > strategy.rsiOverbought && currentPrice > sma) {
      return { action: 'PUT', confidence: Math.abs(rsi - strategy.rsiOverbought) / 10 };
    }

    return null;
  };

  // Connect to Deriv API
  const connect = () => {
    if (!apiToken) {
      addLog('Please enter your Deriv demo API token', 'error');
      return;
    }

    ws.current = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
    
    ws.current.onopen = () => {
      addLog('Connected to Deriv API', 'success');
      ws.current.send(JSON.stringify({ authorize: apiToken }));
    };

    ws.current.onmessage = (msg) => {
      const data = JSON.parse(msg.data);
      
      if (data.authorize) {
        setConnected(true);
        setBalance(data.authorize.balance);
        addLog(`Authorized. Balance: $${data.authorize.balance}`, 'success');
        // Subscribe to tick stream for Volatility 75 Index
        ws.current.send(JSON.stringify({ 
          ticks: 'R_75',
          subscribe: 1
        }));
      }

      if (data.tick) {
        const price = parseFloat(data.tick.quote);
        priceHistory.current.push(price);
        if (priceHistory.current.length > 100) {
          priceHistory.current.shift();
        }

        // Check for trading signals if bot is running
        if (isRunning.current && priceHistory.current.length >= 30) {
          checkForTrade();
        }
      }

      if (data.proposal_open_contract) {
        handleTradeResult(data.proposal_open_contract);
      }

      if (data.error) {
        addLog(`Error: ${data.error.message}`, 'error');
      }
    };

    ws.current.onerror = (error) => {
      addLog('Connection error', 'error');
      setConnected(false);
    };

    ws.current.onclose = () => {
      addLog('Disconnected from Deriv', 'error');
      setConnected(false);
      setRunning(false);
      isRunning.current = false;
    };
  };

  const checkForTrade = () => {
    const signal = analyzeMarket();
    
    if (signal && balance >= strategy.stake) {
      // Check stop loss and target profit
      if (stats.profit <= -strategy.stopLoss) {
        addLog(`Stop loss hit: $${stats.profit.toFixed(2)}`, 'error');
        stopBot();
        return;
      }
      
      if (stats.profit >= strategy.targetProfit) {
        addLog(`Target profit reached: $${stats.profit.toFixed(2)}`, 'success');
        stopBot();
        return;
      }

      executeTrade(signal.action);
    }
  };

  const executeTrade = (direction) => {
    const contractType = direction === 'CALL' ? 'CALL' : 'PUT';
    
    // Demo simulation (in real implementation, use Deriv's buy API)
    const trade = {
      id: Date.now(),
      type: contractType,
      stake: strategy.stake,
      time: new Date().toLocaleTimeString(),
      status: 'pending'
    };

    addLog(`Opening ${contractType} position - Stake: $${strategy.stake}`, 'info');
    setTrades(prev => [trade, ...prev.slice(0, 19)]);

    // Simulate trade result after 5 ticks (demo only)
    setTimeout(() => {
      const win = Math.random() > 0.45; // 55% win rate for demo
      const payout = win ? strategy.stake * 0.95 : -strategy.stake;
      
      setBalance(prev => prev + payout);
      setStats(prev => ({
        wins: prev.wins + (win ? 1 : 0),
        losses: prev.losses + (win ? 0 : 1),
        profit: prev.profit + payout
      }));

      setTrades(prev => prev.map(t => 
        t.id === trade.id 
          ? { ...t, status: win ? 'win' : 'loss', payout }
          : t
      ));

      addLog(
        `Trade ${win ? 'WON' : 'LOST'}: ${payout > 0 ? '+' : ''}$${payout.toFixed(2)}`,
        win ? 'success' : 'error'
      );
    }, 5000);
  };

  const handleTradeResult = (contract) => {
    // Handle actual trade results from Deriv API
    const profit = contract.profit;
    const win = profit > 0;
    
    setBalance(contract.balance);
    setStats(prev => ({
      wins: prev.wins + (win ? 1 : 0),
      losses: prev.losses + (win ? 0 : 1),
      profit: prev.profit + profit
    }));

    addLog(
      `Trade result: ${win ? 'WON' : 'LOST'} ${profit > 0 ? '+' : ''}$${profit.toFixed(2)}`,
      win ? 'success' : 'error'
    );
  };

  const startBot = () => {
    if (!connected) {
      addLog('Please connect to Deriv first', 'error');
      return;
    }
    setRunning(true);
    isRunning.current = true;
    addLog('Bot started - Monitoring market...', 'success');
  };

  const stopBot = () => {
    setRunning(false);
    isRunning.current = false;
    addLog('Bot stopped', 'info');
  };

  const winRate = stats.wins + stats.losses > 0 
    ? ((stats.wins / (stats.wins + stats.losses)) * 100).toFixed(1)
    : 0;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-4">
      <div className="max-w-7xl mx-auto">
        <div className="mb-6">
          <h1 className="text-3xl font-bold mb-2 flex items-center gap-2">
            <Activity className="text-blue-400" />
            Deriv Demo Trading Bot
          </h1>
          <p className="text-slate-400">RSI + Moving Average Strategy | Demo Account Only</p>
        </div>

        {/* Connection & Settings */}
        {showSettings && (
          <div className="bg-slate-800 rounded-lg p-6 mb-6 border border-slate-700">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Settings size={20} />
              Configuration
            </h2>
            
            <div className="grid md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm text-slate-300 mb-2">
                  Deriv Demo API Token
                </label>
                <input
                  type="password"
                  value={apiToken}
                  onChange={(e) => setApiToken(e.target.value)}
                  placeholder="Get from Deriv > Manage API tokens"
                  className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white"
                />
                <p className="text-xs text-slate-400 mt-1">
                  Create a demo token at: app.deriv.com → Settings → API Token
                </p>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-300 mb-2">Stake ($)</label>
                  <input
                    type="number"
                    value={strategy.stake}
                    onChange={(e) => setStrategy(prev => ({ ...prev, stake: parseFloat(e.target.value) }))}
                    className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-300 mb-2">Stop Loss ($)</label>
                  <input
                    type="number"
                    value={strategy.stopLoss}
                    onChange={(e) => setStrategy(prev => ({ ...prev, stopLoss: parseFloat(e.target.value) }))}
                    className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2"
                  />
                </div>
              </div>
            </div>

            <div className="flex gap-3 mt-4">
              {!connected ? (
                <button
                  onClick={connect}
                  className="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded font-semibold"
                >
                  Connect to Deriv
                </button>
              ) : (
                <button
                  onClick={() => setShowSettings(false)}
                  className="bg-green-600 hover:bg-green-700 px-6 py-2 rounded font-semibold"
                >
                  Hide Settings
                </button>
              )}
            </div>
          </div>
        )}

        {/* Stats Dashboard */}
        <div className="grid md:grid-cols-4 gap-4 mb-6">
          <div className="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <div className="flex items-center justify-between mb-2">
              <span className="text-slate-400 text-sm">Balance</span>
              <DollarSign size={18} className="text-green-400" />
            </div>
            <div className="text-2xl font-bold">${balance.toFixed(2)}</div>
          </div>

          <div className="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <div className="flex items-center justify-between mb-2">
              <span className="text-slate-400 text-sm">Profit/Loss</span>
              {stats.profit >= 0 ? <TrendingUp size={18} className="text-green-400" /> : <TrendingDown size={18} className="text-red-400" />}
            </div>
            <div className={`text-2xl font-bold ${stats.profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
              {stats.profit >= 0 ? '+' : ''}${stats.profit.toFixed(2)}
            </div>
          </div>

          <div className="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <div className="flex items-center justify-between mb-2">
              <span className="text-slate-400 text-sm">Win Rate</span>
              <Activity size={18} className="text-blue-400" />
            </div>
            <div className="text-2xl font-bold">{winRate}%</div>
            <div className="text-xs text-slate-400">{stats.wins}W / {stats.losses}L</div>
          </div>

          <div className="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <div className="flex items-center justify-between mb-2">
              <span className="text-slate-400 text-sm">Status</span>
              <div className={`w-3 h-3 rounded-full ${connected ? 'bg-green-400' : 'bg-red-400'}`} />
            </div>
            <div className="text-lg font-bold">{running ? 'Running' : 'Stopped'}</div>
          </div>
        </div>

        {/* Controls */}
        {connected && (
          <div className="bg-slate-800 rounded-lg p-4 mb-6 border border-slate-700 flex gap-3">
            {!running ? (
              <button
                onClick={startBot}
                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 px-6 py-3 rounded font-semibold"
              >
                <Play size={18} />
                Start Bot
              </button>
            ) : (
              <button
                onClick={stopBot}
                className="flex items-center gap-2 bg-red-600 hover:bg-red-700 px-6 py-3 rounded font-semibold"
              >
                <Square size={18} />
                Stop Bot
              </button>
            )}
            <button
              onClick={() => setShowSettings(!showSettings)}
              className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded"
            >
              <Settings size={18} />
              Settings
            </button>
          </div>
        )}

        {/* Warning */}
        <div className="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-4 mb-6">
          <div className="flex gap-3">
            <AlertCircle className="text-yellow-400 flex-shrink-0" size={20} />
            <div className="text-sm">
              <p className="font-semibold text-yellow-400 mb-1">Demo Mode - Educational Purpose Only</p>
              <p className="text-slate-300">This bot is for testing strategies on demo accounts. Past performance does not guarantee future results. Trading involves risk of loss.</p>
            </div>
          </div>
        </div>

        {/* Trade History & Logs */}
        <div className="grid md:grid-cols-2 gap-6">
          <div className="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <h3 className="font-semibold mb-3">Recent Trades</h3>
            <div className="space-y-2 max-h-96 overflow-y-auto">
              {trades.length === 0 ? (
                <p className="text-slate-400 text-sm">No trades yet</p>
              ) : (
                trades.map(trade => (
                  <div key={trade.id} className="bg-slate-700 rounded p-3 flex justify-between items-center">
                    <div>
                      <div className="font-semibold">{trade.type}</div>
                      <div className="text-xs text-slate-400">{trade.time}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-sm text-slate-400">Stake: ${trade.stake}</div>
                      {trade.status !== 'pending' && (
                        <div className={`font-semibold ${trade.payout >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                          {trade.payout >= 0 ? '+' : ''}${trade.payout?.toFixed(2)}
                        </div>
                      )}
                      {trade.status === 'pending' && (
                        <div className="text-yellow-400 text-sm">Pending...</div>
                      )}
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>

          <div className="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <h3 className="font-semibold mb-3">Activity Log</h3>
            <div className="space-y-1 max-h-96 overflow-y-auto font-mono text-xs">
              {logs.length === 0 ? (
                <p className="text-slate-400">No activity yet</p>
              ) : (
                logs.map((log, i) => (
                  <div key={i} className={`${
                    log.type === 'error' ? 'text-red-400' :
                    log.type === 'success' ? 'text-green-400' :
                    'text-slate-300'
                  }`}>
                    [{log.time}] {log.message}
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default DerivDemoBot;
