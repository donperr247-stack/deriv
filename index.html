<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deriv Martingale Bot</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const DerivBot = () => {
            const [connected, setConnected] = useState(false);
            const [running, setRunning] = useState(false);
            const [balance, setBalance] = useState(10000);
            const [trades, setTrades] = useState([]);
            const [stats, setStats] = useState({ wins: 0, losses: 0, profit: 0 });
            const [apiToken, setApiToken] = useState('');
            const [logs, setLogs] = useState([]);
            const [martingaleStep, setMartingaleStep] = useState(0);
            const [currentStake, setCurrentStake] = useState(10);
            const [tradingState, setTradingState] = useState('IDLE');
            
            const [config, setConfig] = useState({
                baseStake: 10,
                martingaleEnabled: true,
                martingaleMultiplier: 2,
                maxMartingaleSteps: 5,
                rsiPeriod: 14,
                rsiOversold: 40,
                rsiOverbought: 60,
                maPeriod: 10,
                stopLoss: 500,
                targetProfit: 200,
                maxStake: 1000
            });

            const ws = useRef(null);
            const priceHistory = useRef([]);
            const activeContract = useRef(null);
            const runningRef = useRef(false);
            const currentStakeRef = useRef(10);
            const martingaleStepRef = useRef(0);

            const log = (msg, type = 'info') => {
                const colors = { success: 'üü¢', error: 'üî¥', info: 'üîµ', warn: 'üü°' };
                console.log(`${colors[type] || '‚ö™'} ${msg}`);
                setLogs(prev => [...prev.slice(-49), { 
                    time: new Date().toLocaleTimeString(), 
                    msg, 
                    type 
                }]);
            };

            const calculateRSI = (prices, period = 14) => {
                if (prices.length < period + 1) return 50;
                let gains = 0, losses = 0;
                for (let i = prices.length - period; i < prices.length; i++) {
                    const diff = prices[i] - prices[i - 1];
                    if (diff > 0) gains += diff;
                    else losses += Math.abs(diff);
                }
                const avgGain = gains / period;
                const avgLoss = losses / period;
                if (avgLoss === 0) return 100;
                const rs = avgGain / avgLoss;
                return 100 - (100 / (1 + rs));
            };

            const calculateSMA = (prices, period = 20) => {
                if (prices.length < period) return prices[prices.length - 1];
                const slice = prices.slice(-period);
                return slice.reduce((a, b) => a + b, 0) / period;
            };

            const getSignal = () => {
                const prices = priceHistory.current;
                const minRequired = Math.max(config.rsiPeriod + 1, config.maPeriod);
                
                if (prices.length < minRequired) {
                    if (prices.length % 5 === 0) {
                        log(`Collecting price data: ${prices.length}/${minRequired}`, 'info');
                    }
                    return null;
                }

                const rsi = calculateRSI(prices, config.rsiPeriod);
                const sma = calculateSMA(prices, config.maPeriod);
                const currentPrice = prices[prices.length - 1];

                // Log market conditions every 10 ticks when running
                if (runningRef.current && prices.length % 10 === 0) {
                    log(`Market: Price=${currentPrice.toFixed(5)} | RSI=${rsi.toFixed(1)} | SMA=${sma.toFixed(5)}`, 'info');
                }

                if (rsi < config.rsiOversold && currentPrice < sma) {
                    log(`üöÄ CALL Signal! RSI=${rsi.toFixed(1)} < ${config.rsiOversold} & Price=${currentPrice.toFixed(5)} < SMA=${sma.toFixed(5)}`, 'success');
                    return 'CALL';
                }
                
                if (rsi > config.rsiOverbought && currentPrice > sma) {
                    log(`üöÄ PUT Signal! RSI=${rsi.toFixed(1)} > ${config.rsiOverbought} & Price=${currentPrice.toFixed(5)} > SMA=${sma.toFixed(5)}`, 'success');
                    return 'PUT';
                }

                return null;
            };

            const handleTradeResult = (won) => {
                if (won) {
                    log(`‚úÖ WIN! Resetting martingale to base stake ${config.baseStake}`, 'success');
                    setMartingaleStep(0);
                    setCurrentStake(config.baseStake);
                } else {
                    if (!config.martingaleEnabled) {
                        log(`Martingale disabled - keeping base stake ${config.baseStake}`, 'info');
                        setCurrentStake(config.baseStake);
                        return;
                    }
                    
                    const nextStep = martingaleStep + 1;
                    
                    if (nextStep > config.maxMartingaleSteps) {
                        log(`‚ö†Ô∏è Max martingale steps (${config.maxMartingaleSteps}) reached! Resetting to base stake`, 'error');
                        setMartingaleStep(0);
                        setCurrentStake(config.baseStake);
                        return;
                    }
                    
                    const newStake = Math.min(
                        config.baseStake * Math.pow(config.martingaleMultiplier, nextStep),
                        config.maxStake
                    );
                    
                    log(`‚ùå LOSS! Martingale step ${martingaleStep} ‚Üí ${nextStep}: ${currentStake.toFixed(2)} ‚Üí ${newStake.toFixed(2)}`, 'error');
                    
                    setMartingaleStep(nextStep);
                    setCurrentStake(newStake);
                }
            };

            const connect = () => {
                if (!apiToken) {
                    log('Please enter API token', 'error');
                    return;
                }

                ws.current = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
                
                ws.current.onopen = () => {
                    log('Connected to Deriv WebSocket', 'success');
                    ws.current.send(JSON.stringify({ authorize: apiToken }));
                };

                ws.current.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    
                    if (data.authorize) {
                        setConnected(true);
                        setBalance(data.authorize.balance);
                        log(`Authorized! Balance: $${data.authorize.balance}`, 'success');
                        ws.current.send(JSON.stringify({ ticks: 'R_75', subscribe: 1 }));
                    }

                    if (data.tick) {
                        const price = parseFloat(data.tick.quote);
                        priceHistory.current.push(price);
                        if (priceHistory.current.length > 100) priceHistory.current.shift();

                        // Check immediately when we have enough data
                        if (runningRef.current && tradingState === 'IDLE') {
                            const minRequired = Math.max(config.rsiPeriod + 1, config.maPeriod);
                            if (priceHistory.current.length >= minRequired) {
                                checkForTrade();
                            }
                        }
                    }

                    if (data.proposal) {
                        ws.current.send(JSON.stringify({
                            buy: data.proposal.id,
                            price: data.proposal.ask_price
                        }));
                    }

                    if (data.buy) {
                        activeContract.current = data.buy.contract_id;
                        log(`Contract purchased: ${data.buy.contract_id}`, 'success');
                        setBalance(data.buy.balance_after);
                        setTradingState('TRADING');
                        
                        ws.current.send(JSON.stringify({
                            proposal_open_contract: 1,
                            contract_id: data.buy.contract_id,
                            subscribe: 1
                        }));
                    }

                    if (data.proposal_open_contract) {
                        const contract = data.proposal_open_contract;
                        if (contract.contract_id !== activeContract.current) return;
                        
                        if (contract.status === 'sold' || contract.is_sold) {
                            const profit = parseFloat(contract.profit);
                            const won = profit > 0;
                            
                            log(`Contract closed: ${won ? 'WON' : 'LOST'} ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}`, won ? 'success' : 'error');
                            
                            setBalance(parseFloat(contract.balance_after));
                            setStats(prev => ({
                                wins: prev.wins + (won ? 1 : 0),
                                losses: prev.losses + (won ? 0 : 1),
                                profit: prev.profit + profit
                            }));

                            setTrades(prev => [{
                                id: Date.now(),
                                type: contract.contract_type,
                                stake: parseFloat(contract.buy_price || currentStakeRef.current),
                                payout: profit,
                                status: won ? 'win' : 'loss',
                                martingaleStep: martingaleStepRef.current,
                                time: new Date().toLocaleTimeString()
                            }, ...prev.slice(0, 19)]);

                            // Handle martingale BEFORE resetting state
                            const currentStep = martingaleStep;
                            handleTradeResult(won);
                            
                            activeContract.current = null;
                            setTradingState('WAITING');
                            
                            setTimeout(() => {
                                setTradingState('IDLE');
                                log(`Ready for next trade (Stake: ${won ? config.baseStake : currentStake})`, 'info');
                            }, 3000);
                        }
                    }

                    if (data.error) {
                        log(`Error: ${data.error.message}`, 'error');
                        activeContract.current = null;
                        setTradingState('IDLE');
                    }
                };

                ws.current.onerror = () => {
                    log('Connection error', 'error');
                    setConnected(false);
                };

                ws.current.onclose = () => {
                    log('Disconnected from Deriv', 'warn');
                    setConnected(false);
                    setRunning(false);
                    runningRef.current = false;
                };
            };

            const checkForTrade = () => {
                if (tradingState !== 'IDLE') return;
                
                if (stats.profit <= -config.stopLoss) {
                    log(`Stop loss hit: $${stats.profit.toFixed(2)}`, 'error');
                    stopBot();
                    return;
                }
                
                if (stats.profit >= config.targetProfit) {
                    log(`Target profit reached: $${stats.profit.toFixed(2)}`, 'success');
                    stopBot();
                    return;
                }

                if (currentStake > balance) {
                    log(`Insufficient balance for $${currentStake} stake`, 'error');
                    stopBot();
                    return;
                }

                const signal = getSignal();
                if (signal) executeTrade(signal);
            };

            const executeTrade = (type) => {
                if (tradingState !== 'IDLE') return;
                
                setTradingState('OPENING');
                
                log(`üöÄ Opening ${type} - Stake: ${currentStake.toFixed(2)} | Martingale Step: ${martingaleStep}`, 'info');
                
                ws.current.send(JSON.stringify({
                    proposal: 1,
                    amount: currentStake,
                    basis: 'stake',
                    contract_type: type,
                    currency: 'USD',
                    duration: 5,
                    duration_unit: 't',
                    symbol: 'R_75'
                }));
            };

            const startBot = () => {
                if (!connected) {
                    log('Please connect first', 'error');
                    return;
                }
                
                if (priceHistory.current.length < Math.max(config.rsiPeriod + 1, config.maPeriod)) {
                    log(`Collecting price data... Need ${Math.max(config.rsiPeriod + 1, config.maPeriod)} ticks, have ${priceHistory.current.length}`, 'warn');
                }
                
                // Reset martingale
                setMartingaleStep(0);
                setCurrentStake(config.baseStake);
                activeContract.current = null;
                setTradingState('IDLE');
                setRunning(true);
                runningRef.current = true;
                
                log('‚úÖ Bot started! Waiting for signals...', 'success');
                log(`üìä Strategy: RSI(${config.rsiPeriod}) < ${config.rsiOversold} or > ${config.rsiOverbought}, MA(${config.maPeriod})`, 'info');
                log(`üí∞ Martingale: ${config.martingaleEnabled ? `${config.martingaleMultiplier}x up to ${config.maxMartingaleSteps} steps` : 'DISABLED'}`, 'info');
                log(`üéØ Starting stake: ${config.baseStake}`, 'info');
            };

            const stopBot = () => {
                setRunning(false);
                runningRef.current = false;
                setTradingState('IDLE');
                activeContract.current = null;
                log('Bot stopped', 'warn');
            };

            const winRate = stats.wins + stats.losses > 0 
                ? ((stats.wins / (stats.wins + stats.losses)) * 100).toFixed(1)
                : 0;

            const maxPossibleLoss = config.baseStake * 
                (Math.pow(config.martingaleMultiplier, config.maxMartingaleSteps + 1) - 1) / 
                (config.martingaleMultiplier - 1);

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="mb-6">
                            <h1 className="text-4xl font-bold mb-2">üéØ Deriv Martingale Bot</h1>
                            <p className="text-gray-400">RSI + MA Strategy with Martingale Money Management</p>
                        </div>

                        {/* Warning */}
                        <div className="bg-red-900/30 border-2 border-red-500 rounded-lg p-4 mb-6">
                            <div className="flex gap-3">
                                <div className="text-3xl">‚ö†Ô∏è</div>
                                <div>
                                    <p className="font-bold text-red-400 text-lg mb-2">MARTINGALE RISK WARNING</p>
                                    <p className="text-white mb-1">Max loss in {config.maxMartingaleSteps} consecutive losses: <span className="font-bold text-red-400">${maxPossibleLoss.toFixed(2)}</span></p>
                                    <p className="text-gray-300 text-sm">Use demo account first! This strategy can cause significant losses.</p>
                                </div>
                            </div>
                        </div>

                        {/* Connection */}
                        <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
                            <h2 className="text-xl font-semibold mb-4">‚öôÔ∏è Configuration</h2>
                            
                            <div className="mb-4">
                                <label className="block text-sm text-gray-300 mb-2">Deriv API Token (Demo)</label>
                                <input
                                    type="password"
                                    value={apiToken}
                                    onChange={(e) => setApiToken(e.target.value)}
                                    placeholder="Get from app.deriv.com ‚Üí Settings ‚Üí API Token"
                                    className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                    disabled={connected}
                                />
                                <p className="text-xs text-gray-400 mt-1">Make sure to enable "Trade" permission</p>
                            </div>

                            <div className="grid md:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm text-gray-300 mb-2">Base Stake ($)</label>
                                    <input
                                        type="number"
                                        value={config.baseStake}
                                        onChange={(e) => {
                                            const val = parseFloat(e.target.value);
                                            setConfig(prev => ({ ...prev, baseStake: val }));
                                            setCurrentStake(val);
                                        }}
                                        className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                        disabled={running}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-300 mb-2">Multiplier</label>
                                    <input
                                        type="number"
                                        value={config.martingaleMultiplier}
                                        onChange={(e) => setConfig(prev => ({ ...prev, martingaleMultiplier: parseFloat(e.target.value) }))}
                                        className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                        step="0.1"
                                        disabled={running}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-300 mb-2">Max Steps</label>
                                    <input
                                        type="number"
                                        value={config.maxMartingaleSteps}
                                        onChange={(e) => setConfig(prev => ({ ...prev, maxMartingaleSteps: parseInt(e.target.value) }))}
                                        className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                        disabled={running}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-300 mb-2">MA Period</label>
                                    <input
                                        type="number"
                                        value={config.maPeriod}
                                        onChange={(e) => setConfig(prev => ({ ...prev, maPeriod: parseInt(e.target.value) }))}
                                        className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                        disabled={running}
                                    />
                                </div>
                            </div>

                            <div className="grid md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm text-gray-300 mb-2">RSI Oversold (Buy below)</label>
                                    <input
                                        type="number"
                                        value={config.rsiOversold}
                                        onChange={(e) => setConfig(prev => ({ ...prev, rsiOversold: parseInt(e.target.value) }))}
                                        className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                        disabled={running}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-300 mb-2">RSI Overbought (Sell above)</label>
                                    <input
                                        type="number"
                                        value={config.rsiOverbought}
                                        onChange={(e) => setConfig(prev => ({ ...prev, rsiOverbought: parseInt(e.target.value) }))}
                                        className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                        disabled={running}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-300 mb-2">RSI Period</label>
                                    <input
                                        type="number"
                                        value={config.rsiPeriod}
                                        onChange={(e) => setConfig(prev => ({ ...prev, rsiPeriod: parseInt(e.target.value) }))}
                                        className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                        disabled={running}
                                    />
                                </div>
                            </div>

                            <div className="flex gap-3">
                                {!connected ? (
                                    <button onClick={connect} className="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded font-semibold">
                                        Connect
                                    </button>
                                ) : !running ? (
                                    <button onClick={startBot} className="bg-green-600 hover:bg-green-700 px-6 py-2 rounded font-semibold">
                                        ‚ñ∂Ô∏è Start Bot
                                    </button>
                                ) : (
                                    <button onClick={stopBot} className="bg-red-600 hover:bg-red-700 px-6 py-2 rounded font-semibold">
                                        ‚è∏Ô∏è Stop Bot
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="grid md:grid-cols-5 gap-4 mb-6">
                            <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div className="text-gray-400 text-sm mb-1">Balance</div>
                                <div className="text-2xl font-bold">${balance.toFixed(2)}</div>
                            </div>
                            <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div className="text-gray-400 text-sm mb-1">Profit/Loss</div>
                                <div className={`text-2xl font-bold ${stats.profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {stats.profit >= 0 ? '+' : ''}${stats.profit.toFixed(2)}
                                </div>
                            </div>
                            <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div className="text-gray-400 text-sm mb-1">Current Stake</div>
                                <div className="text-2xl font-bold">${currentStake.toFixed(2)}</div>
                                <div className="text-xs text-gray-400">Step: {martingaleStep}</div>
                            </div>
                            <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div className="text-gray-400 text-sm mb-1">Win Rate</div>
                                <div className="text-2xl font-bold">{winRate}%</div>
                                <div className="text-xs text-gray-400">{stats.wins}W / {stats.losses}L</div>
                            </div>
                            <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div className="text-gray-400 text-sm mb-1">Status</div>
                                <div className="text-lg font-bold">{tradingState}</div>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            {/* Trades */}
                            <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <h3 className="text-lg font-semibold mb-3">üìä Recent Trades</h3>
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {trades.map(trade => (
                                        <div key={trade.id} className={`p-3 rounded border ${trade.status === 'win' ? 'bg-green-900/20 border-green-600' : 'bg-red-900/20 border-red-600'}`}>
                                            <div className="flex justify-between items-center">
                                                <span className="font-semibold">{trade.type}</span>
                                                <span className={trade.status === 'win' ? 'text-green-400' : 'text-red-400'}>
                                                    {trade.payout >= 0 ? '+' : ''}${trade.payout.toFixed(2)}
                                                </span>
                                            </div>
                                            <div className="text-xs text-gray-400 mt-1">
                                                Stake: ${trade.stake.toFixed(2)} | Step: {trade.martingaleStep} | {trade.time}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Logs */}
                            <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <h3 className="text-lg font-semibold mb-3">üìù Activity Log</h3>
                                <div className="space-y-1 max-h-96 overflow-y-auto font-mono text-xs">
                                    {logs.map((log, i) => (
                                        <div key={i} className={`${
                                            log.type === 'success' ? 'text-green-400' :
                                            log.type === 'error' ? 'text-red-400' :
                                            log.type === 'warn' ? 'text-yellow-400' :
                                            'text-gray-300'
                                        }`}>
                                            [{log.time}] {log.msg}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DerivBot />, document.getElementById('root'));
    </script>
</body>
</html>
