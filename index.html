<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deriv Martingale Bot - FIXED</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef } = React;

        const DerivBot = () => {
            const [connected, setConnected] = useState(false);
            const [running, setRunning] = useState(false);
            const [balance, setBalance] = useState(10000);
            const [stats, setStats] = useState({ wins: 0, losses: 0, profit: 0 });
            const [apiToken, setApiToken] = useState('');
            const [logs, setLogs] = useState([]);
            const [martingaleStep, setMartingaleStep] = useState(0);
            const [currentStake, setCurrentStake] = useState(10);
            const [tradingState, setTradingState] = useState('IDLE'); // IDLE or BUSY
            
            const [config, setConfig] = useState({
                baseStake: 10,
                multiplier: 2,
                maxSteps: 5,
                stopLoss: 500,
                targetProfit: 200
            });

            const ws = useRef(null);
            const priceHistory = useRef([]);
            const activeContract = useRef(null);

            const log = (msg, type = 'info') => {
                console.log(`[${type}]`, msg);
                setLogs(prev => [...prev.slice(-30), { time: new Date().toLocaleTimeString(), msg, type }]);
            };

            const calculateRSI = (prices) => {
                if (prices.length < 15) return 50;
                let gains = 0, losses = 0;
                for (let i = prices.length - 14; i < prices.length; i++) {
                    const diff = prices[i] - prices[i - 1];
                    if (diff > 0) gains += diff;
                    else losses += Math.abs(diff);
                }
                const avgGain = gains / 14;
                const avgLoss = losses / 14;
                if (avgLoss === 0) return 100;
                const rs = avgGain / avgLoss;
                return 100 - (100 / (1 + rs));
            };

            const getSignal = () => {
                if (priceHistory.current.length < 30) return null;
                const rsi = calculateRSI(priceHistory.current);
                if (rsi < 30) return 'CALL';
                if (rsi > 70) return 'PUT';
                return null;
            };

            const connect = () => {
                ws.current = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
                
                ws.current.onopen = () => {
                    log('Connected', 'success');
                    ws.current.send(JSON.stringify({ authorize: apiToken }));
                };

                ws.current.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    
                    if (data.authorize) {
                        setConnected(true);
                        setBalance(data.authorize.balance);
                        log(`Authorized. Balance: $${data.authorize.balance}`, 'success');
                        ws.current.send(JSON.stringify({ ticks: 'R_75', subscribe: 1 }));
                    }

                    if (data.tick) {
                        priceHistory.current.push(parseFloat(data.tick.quote));
                        if (priceHistory.current.length > 100) priceHistory.current.shift();
                        
                        if (running && tradingState === 'IDLE') {
                            const signal = getSignal();
                            if (signal) executeTrade(signal);
                        }
                    }

                    if (data.proposal) {
                        ws.current.send(JSON.stringify({ buy: data.proposal.id, price: data.proposal.ask_price }));
                    }

                    if (data.buy) {
                        activeContract.current = data.buy.contract_id;
                        log(`Contract ${data.buy.contract_id} bought`, 'success');
                        setBalance(data.buy.balance_after);
                        ws.current.send(JSON.stringify({
                            proposal_open_contract: 1,
                            contract_id: data.buy.contract_id,
                            subscribe: 1
                        }));
                    }

                    if (data.proposal_open_contract) {
                        const contract = data.proposal_open_contract;
                        
                        // ONLY process OUR active contract
                        if (contract.contract_id !== activeContract.current) return;
                        
                        if (contract.status === 'sold' || contract.is_sold) {
                            const profit = parseFloat(contract.profit);
                            const won = profit > 0;
                            
                            log(`${won ? 'WON' : 'LOST'}: ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}`, won ? 'success' : 'error');
                            
                            setBalance(parseFloat(contract.balance_after));
                            setStats(prev => ({
                                wins: prev.wins + (won ? 1 : 0),
                                losses: prev.losses + (won ? 0 : 1),
                                profit: prev.profit + profit
                            }));

                            // Handle Martingale
                            if (won) {
                                setMartingaleStep(0);
                                setCurrentStake(config.baseStake);
                                log(`âœ… Martingale RESET to $${config.baseStake}`, 'success');
                            } else {
                                const nextStep = martingaleStep + 1;
                                if (nextStep > config.maxSteps) {
                                    setMartingaleStep(0);
                                    setCurrentStake(config.baseStake);
                                    log(`âš ï¸ Max steps reached! Reset to $${config.baseStake}`, 'error');
                                } else {
                                    const newStake = config.baseStake * Math.pow(config.multiplier, nextStep);
                                    setMartingaleStep(nextStep);
                                    setCurrentStake(newStake);
                                    log(`âŒ Martingale Step ${nextStep}: Next stake = $${newStake.toFixed(2)}`, 'error');
                                }
                            }

                            // Reset and wait
                            activeContract.current = null;
                            setTradingState('BUSY');
                            setTimeout(() => {
                                setTradingState('IDLE');
                                log('Ready for next trade', 'info');
                            }, 3000);
                        }
                    }

                    if (data.error) {
                        log(`Error: ${data.error.message}`, 'error');
                        activeContract.current = null;
                        setTradingState('IDLE');
                    }
                };

                ws.current.onclose = () => {
                    log('Disconnected', 'error');
                    setConnected(false);
                    setRunning(false);
                };
            };

            const executeTrade = (type) => {
                if (tradingState !== 'IDLE') return;
                if (stats.profit <= -config.stopLoss) { log('Stop loss hit', 'error'); stopBot(); return; }
                if (stats.profit >= config.targetProfit) { log('Target profit hit', 'success'); stopBot(); return; }
                
                setTradingState('BUSY');
                log(`ðŸš€ ${type} - Stake: $${currentStake.toFixed(2)} (Step: ${martingaleStep})`, 'info');
                
                ws.current.send(JSON.stringify({
                    proposal: 1,
                    amount: currentStake,
                    basis: 'stake',
                    contract_type: type,
                    currency: 'USD',
                    duration: 5,
                    duration_unit: 't',
                    symbol: 'R_75'
                }));
            };

            const startBot = () => {
                setMartingaleStep(0);
                setCurrentStake(config.baseStake);
                activeContract.current = null;
                setTradingState('IDLE');
                setRunning(true);
                log('â–¶ï¸ Bot started', 'success');
            };

            const stopBot = () => {
                setRunning(false);
                setTradingState('IDLE');
                activeContract.current = null;
                log('â¸ï¸ Bot stopped', 'info');
            };

            const winRate = stats.wins + stats.losses > 0 
                ? ((stats.wins / (stats.wins + stats.losses)) * 100).toFixed(1) : 0;

            return (
                <div className="min-h-screen bg-gray-900 text-white p-6">
                    <div className="max-w-6xl mx-auto">
                        <h1 className="text-3xl font-bold mb-6">Deriv Martingale Bot - ONE TRADE AT A TIME</h1>
                        
                        {/* Config */}
                        <div className="bg-gray-800 p-6 rounded mb-6">
                            <h2 className="text-xl mb-4">Settings</h2>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm mb-1">API Token</label>
                                    <input type="password" value={apiToken} onChange={e => setApiToken(e.target.value)} 
                                        className="w-full bg-gray-700 px-3 py-2 rounded" />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Base Stake</label>
                                    <input type="number" value={config.baseStake} 
                                        onChange={e => setConfig({...config, baseStake: +e.target.value})}
                                        className="w-full bg-gray-700 px-3 py-2 rounded" />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Multiplier</label>
                                    <select value={config.multiplier} 
                                        onChange={e => setConfig({...config, multiplier: +e.target.value})}
                                        className="w-full bg-gray-700 px-3 py-2 rounded">
                                        <option value="1.5">1.5x</option>
                                        <option value="2">2x</option>
                                        <option value="2.5">2.5x</option>
                                        <option value="3">3x</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Max Steps</label>
                                    <input type="number" value={config.maxSteps} 
                                        onChange={e => setConfig({...config, maxSteps: +e.target.value})}
                                        className="w-full bg-gray-700 px-3 py-2 rounded" />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Stop Loss</label>
                                    <input type="number" value={config.stopLoss} 
                                        onChange={e => setConfig({...config, stopLoss: +e.target.value})}
                                        className="w-full bg-gray-700 px-3 py-2 rounded" />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Target Profit</label>
                                    <input type="number" value={config.targetProfit} 
                                        onChange={e => setConfig({...config, targetProfit: +e.target.value})}
                                        className="w-full bg-gray-700 px-3 py-2 rounded" />
                                </div>
                            </div>
                            <div className="flex gap-3">
                                {!connected && <button onClick={connect} className="bg-blue-600 px-6 py-2 rounded">Connect</button>}
                                {connected && !running && <button onClick={startBot} className="bg-green-600 px-6 py-2 rounded">Start</button>}
                                {running && <button onClick={stopBot} className="bg-red-600 px-6 py-2 rounded">Stop</button>}
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                            <div className="bg-gray-800 p-4 rounded">
                                <div className="text-sm text-gray-400">Balance</div>
                                <div className="text-2xl font-bold">${balance.toFixed(2)}</div>
                            </div>
                            <div className="bg-gray-800 p-4 rounded">
                                <div className="text-sm text-gray-400">P/L</div>
                                <div className={`text-2xl font-bold ${stats.profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {stats.profit >= 0 ? '+' : ''}${stats.profit.toFixed(2)}
                                </div>
                            </div>
                            <div className="bg-gray-800 p-4 rounded">
                                <div className="text-sm text-gray-400">Current Stake</div>
                                <div className="text-2xl font-bold">${currentStake.toFixed(2)}</div>
                                <div className="text-xs text-gray-400">Step: {martingaleStep}</div>
                            </div>
                            <div className="bg-gray-800 p-4 rounded">
                                <div className="text-sm text-gray-400">Win Rate</div>
                                <div className="text-2xl font-bold">{winRate}%</div>
                                <div className="text-xs text-gray-400">{stats.wins}W / {stats.losses}L</div>
                            </div>
                            <div className="bg-gray-800 p-4 rounded">
                                <div className="text-sm text-gray-400">State</div>
                                <div className="text-2xl font-bold">{tradingState}</div>
                                <div className={`w-3 h-3 rounded-full ${connected ? 'bg-green-400' : 'bg-red-400'}`}></div>
                            </div>
                        </div>

                        {/* Logs */}
                        <div className="bg-gray-800 p-4 rounded">
                            <h3 className="font-bold mb-2">Activity Log</h3>
                            <div className="space-y-1 max-h-96 overflow-y-auto font-mono text-xs">
                                {logs.map((l, i) => (
                                    <div key={i} className={`${
                                        l.type === 'error' ? 'text-red-400' :
                                        l.type === 'success' ? 'text-green-400' : 'text-gray-300'
                                    }`}>
                                        [{l.time}] {l.msg}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DerivBot />, document.getElementById('root'));
    </script>
</body>
</html>
